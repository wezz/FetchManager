(function(s,c){typeof exports=="object"&&typeof module<"u"?c(exports):typeof define=="function"&&define.amd?define(["exports"],c):(s=typeof globalThis<"u"?globalThis:s||self,c(s.fetchmanager={}))})(this,function(s){"use strict";var b=Object.defineProperty;var O=(s,c,a)=>c in s?b(s,c,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[c]=a;var h=(s,c,a)=>(O(s,typeof c!="symbol"?c+"":c,a),a);var c=Object.defineProperty,a=(i,e,r)=>e in i?c(i,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[e]=r,y=(i,e,r)=>(a(i,typeof e!="symbol"?e+"":e,r),r);class p{constructor(e="cache"){y(this,"prefix"),this.prefix=e}getStorageMedium(e=!0){return e&&typeof window.localStorage<"u"?window.localStorage:e&&typeof window.sessionStorage<"u"?window.sessionStorage:null}Has(e){return typeof this.Get(`${this.prefix}-${e}`)<"u"}Get(e){const r=this.getStorageMedium(!1),t=this.getStorageMedium(!0);let o=!1,n=null;if(r&&t){try{n=r.getItem(`${this.prefix}-${e}`),n=this.toJSONIfJSON(n),o=n!==null}catch{}if(!o)try{n=t.getItem(`${this.prefix}-${e}`),n=this.toJSONIfJSON(n),o=n!==null}catch{}}return n}toJSONIfJSON(e){return typeof e=="string"&&(e.indexOf("{")===0||e.indexOf("[")===0)&&(e=JSON.parse(e)),e}Save(e,r,t=!0){console.warn("StoreManager.Save is deprecated"),this.Set(e,r,t)}Set(e,r,t=!0){const o=this.getStorageMedium(t);let n=!1;if(o){typeof r=="object"&&(r=JSON.stringify(r));try{o.setItem(`${this.prefix}-${e}`,r),n=!0}catch(f){console.error("Unable to save object",f)}}return n}Remove(e){const r=this.getStorageMedium(!0),t=this.getStorageMedium(!1);r&&r.removeItem(`${this.prefix}-${e}`),t&&t.removeItem(`${this.prefix}-${e}`)}}const d=new p("fetchmanager");class g{constructor(){h(this,"moduleName","FetchManager");h(this,"requests",{});h(this,"defaultFetchOptions",{method:"GET",mode:"cors",headers:{"Content-Type":"application/json"}})}ObjToQueryString(e){return typeof e!="object"?"":Object.keys(e).map(r=>{if(Array.isArray(e[r])){for(var t=[],o=0;o<e[r].length;o++)t.push(`${encodeURIComponent(r)}=${encodeURIComponent(e[r][o])}`);return t.join("&")}return encodeURIComponent(r)+"="+encodeURIComponent(e[r])}).join("&")}async Fetch(e){if(!e.url)return console.error("Need a url to do a request"),null;const r=this.getKey(e),t=this.getRequestObj(r,e);let o=this.parseFetchOptions(e);return t.active&&e.url!==t.url&&typeof window.AbortController<"u"&&t.abortcontroller&&typeof t.abortcontroller.abort=="function"&&(t.abortcontroller.abort(),t.abortcontroller=new AbortController,t.active=!1),e.url!==t.url?(typeof t.abortcontroller<"u"&&t.abortcontroller&&typeof t.abortcontroller.signal<"u"&&(e.signal=t.abortcontroller.signal),t.url=this.CompileUrl(e),t.active=!0,t.promise=new Promise(async(n,f)=>{const m=typeof e.requestdelay=="number"?e.requestdelay:0;t.delaytimer!==null&&(window.clearTimeout(t.delaytimer),t.delaytimer=null),t.delaytimer=window.setTimeout(async()=>{try{let l=!t.cache.usecache,u=null;t.cache.usecache&&(u=this.getResponseFromCache(t),u==null&&(l=!0)),l&&(u=await fetch(t.url,o)),t.active=!1,l&&o.headers&&o.headers["Content-Type"]&&o.headers["Content-Type"].indexOf("json")?t.result=await u.json():t.result=u,t.finished=!0,this.saveResponseToCache(t),n(t.result)}catch(l){t.active=!1,console.error(l),f(t)}},m)}),t.promise):t.finished&&t.result!==null?new Promise(async n=>{n(t.result)}):t.promise&&t.active?t.promise:null}GetScript(e){return new Promise((t,o)=>{const n=document.createElement("script");document.body.appendChild(n),n.onload=t,n.onerror=o,n.async=!0,n.src=e})}CompileUrl(e){let r=e.url;const t=typeof e.querystring=="string"?e.querystring:this.ObjToQueryString(e.querystring);return r+=(r.indexOf("?")===-1?"?":"")+t,r}getRequestObj(e,r){return typeof this.requests[e]>"u"&&(this.requests[e]={key:e,url:"",cache:this.getRequestCacheOptions(r),options:r,active:!1,finished:!1,result:null,promise:null,abortcontroller:typeof window.AbortController=="function"?new AbortController:null,delaytimer:null}),this.requests[e]}getResponseFromCache(e){const r=d.Get(e.cache.cachekey);return this.validResponse(r)?r:null}validResponse(e){return e!=null&&(typeof e=="string"||typeof e=="object"&&Object.keys(e).length>0||typeof e=="object"&&typeof e.length=="number")}saveResponseToCache(e){if(e.cache.usecache!==!0||!e.result)return!1;if(!this.validResponse(e.result))return console.info("Result was not accepted so it is not saved to cache",e),!1;e.cache.iscached=!0;try{return d.Set(e.cache.cachekey,e.result,e.cache.pemanent),!0}catch{return console.error("Unable to save"),!1}}parseFetchOptions(e){let r=typeof e.fetchoptions<"u"?e.fetchoptions:{};return r={...this.defaultFetchOptions,...r},r}getRequestCacheOptions(e){return{pemanent:typeof e.cache=="object"&&typeof e.cache.pemanent=="boolean"&&e.cache.pemanent===!0,usecache:typeof e.cache=="boolean"?e.cache:typeof e.cache=="object"&&typeof e.cache.usecache=="boolean"&&e.cache.usecache===!0,cachekey:typeof e.cache=="object"&&typeof e.cache.cachekey=="string"&&e.cache.cachekey.length!==0?e.cache.cachekey:this.getCacheKey(e),iscached:!1}}getCacheKey(e){return this.getKey(e)+this.CompileUrl(e)}getKey(e){return e.key?e.key:this.KeyFromOptions(e)}KeyFromOptions(e){const r=this.CompileUrl(e);return r.substring(0,r.indexOf("?")>0?r.indexOf("?"):r.length)}}s.FetchManager=g,Object.defineProperty(s,Symbol.toStringTag,{value:"Module"})});
