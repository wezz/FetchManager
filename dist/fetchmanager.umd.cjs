(function(a,n){typeof exports=="object"&&typeof module<"u"?n(exports):typeof define=="function"&&define.amd?define(["exports"],n):(a=typeof globalThis<"u"?globalThis:a||self,n(a.fetchmanager={}))})(this,function(a){"use strict";var R=Object.defineProperty;var C=(a,n,i)=>n in a?R(a,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):a[n]=i;var h=(a,n,i)=>(C(a,typeof n!="symbol"?n+"":n,i),i);var n=Object.defineProperty,i=(o,e,r)=>e in o?n(o,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[e]=r,p=(o,e,r)=>(i(o,typeof e!="symbol"?e+"":e,r),r);class b{constructor(e="cache"){p(this,"prefix"),this.prefix=e}getStorageMedium(e=!0){return e&&typeof window.localStorage<"u"?window.localStorage:e&&typeof window.sessionStorage<"u"?window.sessionStorage:null}Has(e){return typeof this.Get(`${this.prefix}-${e}`)<"u"}Get(e){const r=this.getStorageMedium(!1),t=this.getStorageMedium(!0);let c=!1,s=null;if(r&&t){try{s=r.getItem(`${this.prefix}-${e}`),s=this.toJSONIfJSON(s),c=s!==null}catch{}if(!c)try{s=t.getItem(`${this.prefix}-${e}`),s=this.toJSONIfJSON(s),c=s!==null}catch{}}return s}toJSONIfJSON(e){return typeof e=="string"&&(e.indexOf("{")===0||e.indexOf("[")===0)&&(e=JSON.parse(e)),e}Save(e,r,t=!0){console.warn("StoreManager.Save is deprecated"),this.Set(e,r,t)}Set(e,r,t=!0){const c=this.getStorageMedium(t);let s=!1;if(c){typeof r=="object"&&(r=JSON.stringify(r));try{c.setItem(`${this.prefix}-${e}`,r),s=!0}catch(d){console.error("Unable to save object",d)}}return s}Remove(e){const r=this.getStorageMedium(!0),t=this.getStorageMedium(!1);r&&r.removeItem(`${this.prefix}-${e}`),t&&t.removeItem(`${this.prefix}-${e}`)}}var w=Object.defineProperty,S=(o,e,r)=>e in o?w(o,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[e]=r,f=(o,e,r)=>(S(o,typeof e!="symbol"?e+"":e,r),r);class N{constructor(e="",r="",t=null){if(f(this,"storeNamespace","windowReferenceStore"),f(this,"storeName",""),f(this,"root",typeof window<"u"?window:typeof global<"u"?global:typeof document<"u"?document:{}),r?this.storeNamespace=r:console.info("It's recommended to assign a namespace for your stores"),e)this.storeName=e;else{console.error("A store name needs to be specified. Initiation aborted in WindowReferenceStore");return}t!==null&&(this.root=t),this.registerGlobalReferences()}registerGlobalReferences(){typeof this.root[this.storeNamespace]>"u"&&(this.root[this.storeNamespace]={}),typeof this.root[this.storeNamespace][this.storeName]>"u"&&(this.root[this.storeNamespace][this.storeName]={})}has(e){return e?typeof this.root[this.storeNamespace][this.storeName][e]<"u":(console.log(`Attempted to fetch an empty key. Reference store namespace: ${this.storeNamespace}. Reference store name: ${this.storeName}`),!1)}get(e){return this.has(e)?this.root[this.storeNamespace][this.storeName][e]:(console.log(`Could not find reference ${e} in store ${this.storeNamespace} ${this.storeName}`),!1)}set(e,r,t=!1){if(this.has(e)&&!t)return console.warn(`Reference '${e}' already exists in store '${this.storeName}' and override wasn't enabled`),!1;if(typeof r>"u")return console.error(`Can't register a undefined object to store ${this.storeName}`),!1;try{return this.root[this.storeNamespace][this.storeName][e]=r,!0}catch{return!1}}remove(e){return this.has(e)?delete this.root[this.storeNamespace][this.storeName][e]:!1}}const m=new b("fetchmanager"),v=new N("requests","fetchmanagerstore");class O{constructor(){h(this,"moduleName","FetchManager");h(this,"requestStore",v);h(this,"defaultFetchOptions",{method:"GET",mode:"cors",headers:{"Content-Type":"application/json"}})}ObjToQueryString(e){return typeof e!="object"?"":new URLSearchParams(e).toString()}async Fetch(e){if(!e.url)return console.error("Need a url to do a request"),null;const r=this.getKey(e),t=this.getRequestObj(r,e);let c=this.parseFetchOptions(e);return this.debug(t.debug,"Reqobj",t),t.active&&e.url!==t.url&&typeof window.AbortController<"u"&&t.abortcontroller&&typeof t.abortcontroller.abort=="function"&&(t.abortcontroller.abort(),t.abortcontroller=new AbortController,console.info("Previous request was cancelled",t),this.debug(t.debug,"Previous request was cancelled",t),t.active=!1),e.url!==t.url?(typeof t.abortcontroller<"u"&&t.abortcontroller&&typeof t.abortcontroller.signal<"u"&&(e.signal=t.abortcontroller.signal),t.url=this.CompileUrl(e),t.active=!0,t.promise=new Promise(async(s,d)=>{const y=typeof e.requestdelay=="number"?e.requestdelay:0;t.delaytimer!==null&&(window.clearTimeout(t.delaytimer),t.delaytimer=null),this.debug(t.debug,"Request will be delayed by "+y+"ms",t),t.delaytimer=window.setTimeout(async()=>{try{let u=!t.cache.usecache,l=null;t.cache.usecache&&(l=this.getResponseFromCache(t),this.debug(t.debug,"Response from cache ",l),l==null&&(u=!0)),u&&(l=await fetch(t.url,c)),t.active=!1;const g=((c.headers??"")["Content-Type"]??"").toLocaleLowerCase();this.debug(t.debug,"requestContentType ",g),t.returnrequest===!1&&u&&g.indexOf("json")!==-1?t.result=await l.json():t.result=l,t.finished=!0,this.saveResponseToCache(t),s(t.result)}catch(u){t.active=!1,console.error(u),d(t)}},y)}),t.promise):t.finished&&t.result!==null?new Promise(async s=>{s(t.result)}):t.promise&&t.active?t.promise:null}GetScript(e){return new Promise((t,c)=>{const s=document.createElement("script");document.body.appendChild(s),s.onload=t,s.onerror=c,s.async=!0,s.src=e})}CompileUrl(e){let r=e.url;const t=typeof e.querystring=="string"?e.querystring+"":this.ObjToQueryString(e.querystring);return r+=(e.querystring&&r.indexOf("?")===-1?"?":"")+t,r}getRequestObj(e,r){if(!this.requestStore.has(e)){const t={key:e,url:"",cache:this.getRequestCacheOptions(r),options:r,active:!1,finished:!1,result:null,promise:null,abortcontroller:typeof window.AbortController=="function"?new AbortController:null,delaytimer:null,returnrequest:(r==null?void 0:r.returnrequest)??!1,debug:(r==null?void 0:r.debug)??!1};this.requestStore.set(e,t)}return this.requestStore.get(e)}getResponseFromCache(e){const r=m.Get(e.cache.cachekey);return this.validResponse(r)?r:null}validResponse(e){return e!=null&&(typeof e=="string"||typeof e=="object"&&Object.keys(e).length>0||typeof e=="object"&&typeof e.length=="number")}saveResponseToCache(e){if(e.cache.usecache!==!0||!e.result)return!1;let r=this.validResponse(e.result);if(this.debug(e.debug,"Storing response in cache ",e.result),!r)return console.info("Result was not accepted so it is not saved to cache",e),!1;e.cache.iscached=!0;try{return m.Set(e.cache.cachekey,e.result,e.cache.pemanent),!0}catch{return console.error("Unable to save"),!1}}parseFetchOptions(e){let r=typeof e.fetchoptions<"u"?e.fetchoptions:{};return r={...this.defaultFetchOptions,...r},r}getRequestCacheOptions(e){return{pemanent:typeof e.cache=="object"&&typeof e.cache.pemanent=="boolean"&&e.cache.pemanent===!0,usecache:typeof e.cache=="boolean"?e.cache:typeof e.cache=="object"&&typeof e.cache.usecache=="boolean"&&e.cache.usecache===!0,cachekey:typeof e.cache=="object"&&typeof e.cache.cachekey=="string"&&e.cache.cachekey.length!==0?e.cache.cachekey:this.getCacheKey(e),iscached:!1}}getCacheKey(e){return this.getKey(e)+this.CompileUrl(e)}getKey(e){return e.key?e.key:this.KeyFromOptions(e)}KeyFromOptions(e){const r=this.CompileUrl(e);return r.substring(0,r.indexOf("?")>0?r.indexOf("?"):r.length)}debug(e,...r){e&&console.debug(r)}}a.FetchManager=O,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});
