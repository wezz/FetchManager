(function(c,a){typeof exports=="object"&&typeof module<"u"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(c=typeof globalThis<"u"?globalThis:c||self,a(c.fetchmanager={}))})(this,function(c){"use strict";var C=Object.defineProperty;var $=(c,a,l)=>a in c?C(c,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):c[a]=l;var h=(c,a,l)=>($(c,typeof a!="symbol"?a+"":a,l),l);var a=Object.defineProperty,l=(n,e,t)=>e in n?a(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,g=(n,e,t)=>(l(n,typeof e!="symbol"?e+"":e,t),t);class y{constructor(e="cache"){g(this,"prefix"),this.prefix=e}getStorageMedium(e=!0){return typeof window>"u"||typeof window.localStorage>"u"?null:e?window.localStorage:window.sessionStorage}Has(e){return typeof this.Get(`${this.prefix}-${e}`)<"u"}Get(e){const t=this.getStorageMedium(!1),s=this.getStorageMedium(!0);let r=!1,o=null;if(t&&s){try{o=t.getItem(`${this.prefix}-${e}`),o=this.toJSONIfJSON(o),r=o!==null}catch{}if(!r)try{o=s.getItem(`${this.prefix}-${e}`),o=this.toJSONIfJSON(o),r=o!==null}catch{}}return o}toJSONIfJSON(e){return typeof e=="string"&&(e.indexOf("{")===0||e.indexOf("[")===0)&&(e=JSON.parse(e)),e}Save(e,t,s=!0){console.warn("StoreManager.Save is deprecated"),this.Set(e,t,s)}Set(e,t,s=!0){const r=this.getStorageMedium(s);let o=!1;if(r){typeof t=="object"&&(t=JSON.stringify(t));try{r.setItem(`${this.prefix}-${e}`,t),o=!0}catch(i){console.error("Unable to save object",i)}}return o}Remove(e){const t=this.getStorageMedium(!0),s=this.getStorageMedium(!1);t&&t.removeItem(`${this.prefix}-${e}`),s&&s.removeItem(`${this.prefix}-${e}`)}}var b=Object.defineProperty,w=(n,e,t)=>e in n?b(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,d=(n,e,t)=>(w(n,typeof e!="symbol"?e+"":e,t),t);class S{constructor(e="",t="",s=null){if(d(this,"storeNamespace","windowReferenceStore"),d(this,"storeName",""),d(this,"root",typeof window<"u"?window:typeof global<"u"?global:typeof document<"u"?document:{}),t?this.storeNamespace=t:console.info("It's recommended to assign a namespace for your stores"),e)this.storeName=e;else{console.error("A store name needs to be specified. Initiation aborted in WindowReferenceStore");return}s!==null&&(this.root=s),this.registerGlobalReferences()}registerGlobalReferences(){typeof this.root[this.storeNamespace]>"u"&&(this.root[this.storeNamespace]={}),typeof this.root[this.storeNamespace][this.storeName]>"u"&&(this.root[this.storeNamespace][this.storeName]={})}has(e){return e?typeof this.root[this.storeNamespace][this.storeName][e]<"u":(console.log(`Attempted to fetch an empty key. Reference store namespace: ${this.storeNamespace}. Reference store name: ${this.storeName}`),!1)}get(e){return this.has(e)?this.root[this.storeNamespace][this.storeName][e]:(console.log(`Could not find reference ${e} in store ${this.storeNamespace} ${this.storeName}`),!1)}set(e,t,s=!1){if(this.has(e)&&!s)return console.warn(`Reference '${e}' already exists in store '${this.storeName}' and override wasn't enabled`),!1;if(typeof t>"u")return console.error(`Can't register a undefined object to store ${this.storeName}`),!1;try{return this.root[this.storeNamespace][this.storeName][e]=t,!0}catch{return!1}}remove(e){return this.has(e)?delete this.root[this.storeNamespace][this.storeName][e]:!1}}const p=new y("fetchmanager"),N=new S("requests","fetchmanagerstore");class R{constructor(){h(this,"moduleName","FetchManager");h(this,"requestStore",N);h(this,"defaultOptions",{json:!0});h(this,"defaultFetchOptions",{method:"GET",mode:"cors"})}ObjToQueryString(e){return typeof e!="object"?"":new URLSearchParams(e).toString()}async Fetch(e){const t={...this.defaultOptions,...e};if(!t.url)return console.error("Need a url to do a request"),null;const s=this.getKey(t),r=this.getRequestObj(s,t);let o=this.parseFetchOptions(t);if(t.json&&!o.headers){const i=new Headers(o.headers);i.has("Content-Type")||(i.append("Content-Type","application/json"),o.headers=i)}return this.debug(r.debug,"Reqobj",r),r.active&&t.url!==r.url&&typeof window.AbortController<"u"&&r.abortcontroller&&typeof r.abortcontroller.abort=="function"&&(r.abortcontroller.abort(),r.abortcontroller=new AbortController,console.info("Previous request was cancelled",r),this.debug(r.debug,"Previous request was cancelled",r),r.active=!1),t.url!==r.url?(typeof r.abortcontroller<"u"&&r.abortcontroller&&typeof r.abortcontroller.signal<"u"&&(t.signal=r.abortcontroller.signal),r.url=this.CompileUrl(t),r.active=!0,r.promise=new Promise(async(i,v)=>{const m=typeof t.requestdelay=="number"?t.requestdelay:0;r.delaytimer!==null&&(window.clearTimeout(r.delaytimer),r.delaytimer=null),this.debug(r.debug,"Request will be delayed by "+m+"ms",r),r.delaytimer=window.setTimeout(async()=>{try{let f=!r.cache.usecache,u=null;r.cache.usecache&&(u=this.getResponseFromCache(r),this.debug(r.debug,"Response from cache ",u),u==null&&(f=!0)),f&&(u=await fetch(r.url,o),this.debug(r.debug,"Responses object from fetch",u)),r.active=!1;const O=((o.headers??"")["Content-Type"]??"").toLocaleLowerCase();this.debug(r.debug,"requestContentType ",O),this.debug(r.debug,"Returning response object",u),r.result=u,r.finished=!0,this.saveResponseToCache(r),i(r.result)}catch(f){r.active=!1,console.error(f),v(r)}},m)}),r.promise):r.finished&&r.result!==null?new Promise(async i=>{i(r.result)}):r.promise&&r.active?r.promise:null}GetScript(e){return new Promise((s,r)=>{const o=document.createElement("script");document.body.appendChild(o),o.onload=s,o.onerror=r,o.async=!0,o.src=e})}CompileUrl(e){let t=e.url;const s=typeof e.querystring=="string"?e.querystring+"":this.ObjToQueryString(e.querystring);return t+=(e.querystring&&t.indexOf("?")===-1?"?":"")+s,t}getRequestObj(e,t){if(!this.requestStore.has(e)){const s={key:e,url:"",cache:this.getRequestCacheOptions(t),options:t,active:!1,finished:!1,result:null,promise:null,abortcontroller:typeof window.AbortController=="function"?new AbortController:null,delaytimer:null,debug:(t==null?void 0:t.debug)??!1};this.requestStore.set(e,s)}return this.requestStore.get(e)}getResponseFromCache(e){const t=p.Get(e.cache.cachekey);return this.validResponse(t)?t:null}validResponse(e){return e!=null&&(typeof e=="string"||typeof e=="object"&&Object.keys(e).length>0||typeof e=="object"&&typeof e.length=="number")}saveResponseToCache(e){if(e.cache.usecache!==!0||!e.result)return!1;let t=this.validResponse(e.result);if(this.debug(e.debug,"Storing response in cache ",e.result),!t)return console.info("Result was not accepted so it is not saved to cache",e),!1;e.cache.iscached=!0;try{return p.Set(e.cache.cachekey,e.result,e.cache.pemanent),!0}catch{return console.error("Unable to save"),!1}}parseFetchOptions(e){let t=typeof e.fetchoptions<"u"?e.fetchoptions:{};return t={...this.defaultFetchOptions,...t},t}getRequestCacheOptions(e){return{pemanent:typeof e.cache=="object"&&typeof e.cache.pemanent=="boolean"&&e.cache.pemanent===!0,usecache:typeof e.cache=="boolean"?e.cache:typeof e.cache=="object"&&typeof e.cache.usecache=="boolean"&&e.cache.usecache===!0,cachekey:typeof e.cache=="object"&&typeof e.cache.cachekey=="string"&&e.cache.cachekey.length!==0?e.cache.cachekey:this.getCacheKey(e),iscached:!1}}getCacheKey(e){return this.getKey(e)+this.CompileUrl(e)}getKey(e){return e.key?e.key:this.CompileUrl(e)}debug(e,...t){e&&console.debug(t)}}c.FetchManager=R,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
